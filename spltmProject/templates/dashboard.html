{% extends "adminDashBoard.html" %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .dashboard-header {
      color: white;
      margin-bottom: 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dashboard-header h1 {
      font-size: 36px;
      font-weight: 700;
    }

    .dashboard-header p {
      font-size: 16px;
      opacity: 0.9;
      margin-top: 5px;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: 10px 24px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    }

    .stat-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 20px;
    }

    .stat-card-title {
      font-size: 14px;
      color: #666;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card-icon {
      font-size: 32px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .stat-card-value {
      font-size: 42px;
      font-weight: 700;
      color: #333;
      margin-bottom: 15px;
    }

    .stat-card-label {
      font-size: 14px;
      color: #999;
      font-weight: 400;
    }

    .stat-card-unit {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
      margin-left: 5px;
    }

    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      height: 200px;
      margin-bottom: 24px;
    }

    .loader-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .loader-track {
      width: 60px;
      height: 60px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .stat-card-value {
        font-size: 32px;
      }

      .dashboard-header h1 {
        font-size: 28px;
        margin-bottom: 15px;
      }
    }
  </style>

  <!-- Pre Loader -->
  <div class="loader-bg">
    <div class="loader-track"></div>
  </div>

  <div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <div>
        <h1>Welcome, <span id="userName">User</span></h1>
        <p>Here's what's happening in your SplitMoney today</p>
      </div>
      <a href="/logout/" class="logout-btn">Logout</a>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" id="statsGrid">
      <!-- Skeleton Loaders -->
      <div class="skeleton-card skeleton"></div>
      <div class="skeleton-card skeleton"></div>
      <div class="skeleton-card skeleton"></div>
      <div class="skeleton-card skeleton"></div>
    </div>
  </div>

{% endblock %}

{% block extra_js %}
  <script src="{% static 'assets/js/toast.js' %}"></script>
  <script>
    // Hide loader after page loads
    window.addEventListener('load', function() {
      setTimeout(function() {
        const loader = document.querySelector('.loader-bg');
        if (loader) {
          loader.style.display = 'none';
        }
      }, 500);
    });

    $(document).ready(function () {
      // Check if user is authenticated
      const token = getCookie('access_token') 
      const userName = getCookie('user_name') 


      if (!token) {
        showErrorToast("Session expired. Please login again.");
        setTimeout(() => {
          window.location.href = "/login/";
        }, 2000);
        return;
      }

      // Display user name
      $('#userName').text(userName || 'User');

      // Fetch dashboard stats
      fetchDashboardStats();
    });

    function fetchDashboardStats() {
      const token = getCookie('access_token');
      
      if (!token) {
        console.error("No token found!");
        alert("No authentication token. Please login again.");
        window.location.href = "/login/";
        return;
      }

      $.ajax({
        url: "/api/dashboard/stats/",
        type: "GET",
        contentType: "application/json",
        headers: {
          "X-CSRFToken": getCSRFToken(),
          "Authorization": "Bearer " + token
        },
        success: function (response) {
          if (response.IsSuccess && response.Data) {
            displayStats(response.Data);
          } else {
            const msg = response.Message || "Failed to load dashboard";
            console.error("API returned error:", msg);
            if (typeof showErrorToast === 'function') {
              showErrorToast(msg);
            } else {
              alert(msg);
            }
          }
        },
        error: function (xhr) {
          console.error("Error fetching dashboard stats:", xhr.status, xhr.responseText);
          let errorMsg = "Failed to load dashboard";
          
          if (xhr.status === 401) {
            errorMsg = "Session expired. Please login again.";
            if (typeof showErrorToast === 'function') {
              showErrorToast(errorMsg);
            } else {
              alert(errorMsg);
            }
            setTimeout(() => {
              window.location.href = "/login/";
            }, 2000);
          } else {
            try {
              const responseData = JSON.parse(xhr.responseText);
              errorMsg = responseData.Message || responseData.message || errorMsg;
            } catch (e) {
              errorMsg = xhr.statusText || "Failed to load dashboard";
            }
            console.error("Final error message:", errorMsg);
            if (typeof showErrorToast === 'function') {
              showErrorToast(errorMsg);
            } else {
              alert(errorMsg);
            }
          }
        }
      });
    }

    function displayStats(data) {
      console.log("Displaying stats data:", data);
      
      if (!data) {
        console.error("No data provided to displayStats");
        if (typeof showErrorToast === 'function') {
          showErrorToast("No data available to display");
        }
        return;
      }

      try {
        const statsHTML = `
          <div class="stat-card">
            <div class="stat-card-header">
              <div class="stat-card-title">Total Users</div>
              <div class="stat-card-icon">
                <i class="ti ti-users"></i>
              </div>
            </div>
            <div class="stat-card-value">${data.total_users || 0}</div>
            <div class="stat-card-label">Active users in system</div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <div class="stat-card-title">Active Events</div>
              <div class="stat-card-icon">
                <i class="ti ti-calendar-event"></i>
              </div>
            </div>
            <div class="stat-card-value">${data.active_events || 0}</div>
            <div class="stat-card-label">Ongoing and draft events</div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <div class="stat-card-title">Total Payment</div>
              <div class="stat-card-icon">
                <i class="ti ti-currency-rupee"></i>
              </div>
            </div>
            <div class="stat-card-value">₹<span class="stat-card-unit">${formatCurrency(data.total_payment || 0)}</span></div>
            <div class="stat-card-label">Total collected amount</div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <div class="stat-card-title">Pending Payment</div>
              <div class="stat-card-icon">
                <i class="ti ti-hourglass"></i>
              </div>
            </div>
            <div class="stat-card-value">₹<span class="stat-card-unit">${formatCurrency(data.pending_payment || 0)}</span></div>
            <div class="stat-card-label">Amount awaiting confirmation</div>
          </div>
        `;

        $('#statsGrid').html(statsHTML);
        console.log("Stats displayed successfully");
      } catch (error) {
        console.error("Error displaying stats:", error);
        if (typeof showErrorToast === 'function') {
          showErrorToast("Error displaying dashboard data");
        } else {
          alert("Error displaying dashboard data: " + error.message);
        }
      }
    }

    function formatCurrency(amount) {
      return parseFloat(amount).toLocaleString('en-IN', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      });
    }

    function getCSRFToken() {
      let cookieValue = null;
      let cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        let cookie = cookies[i].trim();
        if (cookie.startsWith('csrftoken=')) {
          cookieValue = cookie.substring('csrftoken='.length);
          break;
        }
      }
      return cookieValue;
    }

    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(nameEQ) === 0) {
          return decodeURIComponent(c.substring(nameEQ.length));
        }
      }
      return null;
    }
  </script>
{% endblock %}
