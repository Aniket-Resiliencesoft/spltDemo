{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Dashboard - SplitMoney</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <link rel="icon" href="{% static 'assets/images/favicon.svg' %}" type="image/x-icon">
  <link rel="stylesheet" href="{% static 'assets/fonts/inter/inter.css' %}">
  <link rel="stylesheet" href="{% static 'assets/fonts/tabler-icons.min.css' %}">
  <link rel="stylesheet" href="{% static 'assets/fonts/feather.css' %}">
  <link rel="stylesheet" href="{% static 'assets/fonts/fontawesome.css' %}">
  <link rel="stylesheet" href="{% static 'assets/fonts/material.css' %}">
  <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
  <link rel="stylesheet" href="{% static 'assets/css/style-preset.css' %}">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .dashboard-header {
      color: white;
      margin-bottom: 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dashboard-header h1 {
      font-size: 36px;
      font-weight: 700;
    }

    .dashboard-header p {
      font-size: 16px;
      opacity: 0.9;
      margin-top: 5px;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: 10px 24px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    }

    .stat-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 20px;
    }

    .stat-card-title {
      font-size: 14px;
      color: #666;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card-icon {
      font-size: 32px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .stat-card-value {
      font-size: 42px;
      font-weight: 700;
      color: #333;
      margin-bottom: 15px;
    }

    .stat-card-label {
      font-size: 14px;
      color: #999;
      font-weight: 400;
    }

    .stat-card-unit {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
      margin-left: 5px;
    }

    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      height: 200px;
      margin-bottom: 24px;
    }

    .loader-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .loader-track {
      width: 60px;
      height: 60px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .stat-card-value {
        font-size: 32px;
      }

      .dashboard-header h1 {
        font-size: 28px;
        margin-bottom: 15px;
      }
    }
  </style>
</head>

<body>
  <!-- Pre Loader -->
  <div class="loader-bg">
    <div class="loader-track"></div>
  </div>

  <div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <div>
        <h1>Welcome, <span id="userName">User</span></h1>
        <p>Here's what's happening in your SplitMoney today</p>
      </div>
      <a href="/logout/" class="logout-btn">Logout</a>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" id="statsGrid">
      <!-- Skeleton Loaders -->
      <div class="skeleton-card skeleton"></div>
      <div class="skeleton-card skeleton"></div>
      <div class="skeleton-card skeleton"></div>
    </div>
  </div>

  <!-- JS -->
  <script src="{% static 'assets/js/plugins/popper.min.js' %}"></script>
  <script src="{% static 'assets/js/plugins/bootstrap.min.js' %}"></script>
  <script src="{% static 'assets/js/toast.js' %}"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

  <script>
    // Hide loader after page loads
    window.addEventListener('load', function() {
      setTimeout(function() {
        const loader = document.querySelector('.loader-bg');
        if (loader) {
          loader.style.display = 'none';
        }
      }, 500);
    });

    $(document).ready(function () {
      // Check if user is authenticated
      const token = getCookie('access_token') || localStorage.getItem('access_token');
      const userName = getCookie('user_name') || localStorage.getItem('user_name');

      if (!token) {
        showErrorToast("Session expired. Please login again.");
        setTimeout(() => {
          window.location.href = "/login/";
        }, 2000);
        return;
      }

      // Display user name
      $('#userName').text(userName || 'User');

      // Fetch dashboard stats
      fetchDashboardStats();
    });

    function fetchDashboardStats() {
      $.ajax({
        url: "/api/dashboard/stats/",
        type: "GET",
        contentType: "application/json",
        headers: {
          "X-CSRFToken": getCSRFToken(),
          "Authorization": "Bearer " + (getCookie('access_token') || localStorage.getItem('access_token'))
        },
        success: function (response) {
          if (response.IsSuccess && response.Data) {
            displayStats(response.Data);
          } else {
            showErrorToast(response.Message || "Failed to load dashboard");
          }
        },
        error: function (xhr) {
          if (xhr.status === 401) {
            showErrorToast("Session expired. Please login again.");
            setTimeout(() => {
              window.location.href = "/login/";
            }, 2000);
          } else {
            const errorMessage = getErrorMessage(xhr);
            showErrorToast(errorMessage);
          }
        }
      });
    }

    function displayStats(data) {
      const statsHTML = `
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-title">Total Users</div>
            <div class="stat-card-icon">
              <i class="ti ti-users"></i>
            </div>
          </div>
          <div class="stat-card-value">${data.total_users}</div>
          <div class="stat-card-label">Active users in system</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-title">Active Events</div>
            <div class="stat-card-icon">
              <i class="ti ti-calendar-event"></i>
            </div>
          </div>
          <div class="stat-card-value">${data.active_events}</div>
          <div class="stat-card-label">Ongoing and draft events</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-title">Total Payment</div>
            <div class="stat-card-icon">
              <i class="ti ti-currency-rupee"></i>
            </div>
          </div>
          <div class="stat-card-value">â‚¹<span class="stat-card-unit">${formatCurrency(data.total_payment)}</span></div>
          <div class="stat-card-label">Total collected amount</div>
        </div>
      `;

      $('#statsGrid').html(statsHTML);
    }

    function formatCurrency(amount) {
      return parseFloat(amount).toLocaleString('en-IN', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      });
    }

    function getCSRFToken() {
      let cookieValue = null;
      let cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        let cookie = cookies[i].trim();
        if (cookie.startsWith('csrftoken=')) {
          cookieValue = cookie.substring('csrftoken='.length);
          break;
        }
      }
      return cookieValue;
    }

    function setCookie(name, value, hours) {
      let expires = "";
      if (hours) {
        const date = new Date();
        date.setTime(date.getTime() + (hours * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + encodeURIComponent(value) + expires + "; path=/";
    }

    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(nameEQ) === 0) {
          return decodeURIComponent(c.substring(nameEQ.length));
        }
      }
      return null;
    }
  </script>
</body>
</html>
